/******************************************************************************************
**ÃèÊö:EcanÒÔÖĞ¶Ï·½Ê½ÊµÏÖË«»úÍ¨Ñ¶,¹¦ÄÜB¼üÓÃÓÚÆô¶¯·¢ËÍ,½«ÏàÓ¦µÄÉè¶¨Öµ·¢ËÍ¶Ô·½
*;·¢ËÍÎ»:LED8¡¢LED7¡¢LED6£¬½ÓÊÕÎ»£ºLED3¡¢LED2¡¢LED1,Ê®Áù½øÖÆ·½Ê½
*ÖĞ¶ÏT4PINTÉ¨Ãè°´¼ü(10.24 ms)
******************************************************************************************/

#include"DSP281x_Device.h"

unsigned int LEDReg;
unsigned int LED8=0; //ÏÔÊ¾µÄ·¢ËÍÎ»
unsigned int LED7=0;
unsigned int LED6=0;   
unsigned int LED3=0; //ÏÔÊ¾µÄ½ÓÊÕÎ»
unsigned int LED2=0;
unsigned int LED1=0;
unsigned int KeyReg1;
unsigned int KeyReg2;
unsigned long int i = 0;
void  IOinit(void);
int   KeyIn1(void);
void  KeyFunction1(unsigned int KeyReg1);
void  KeyFunction2(unsigned int KeyReg2);
void Write_LED (int LEDReg);//Í¨¹ıSPIÏòLED·¢ËÍÏÔÊ¾Êı¾İ

Uint16 keyNum = 0x0000;  //°´¼ü´ÎÊı
Uint16 RecieveChar;
Uint16 transmitChar;

Uint32  TestMbox1 = 0;
Uint32  TestMbox2 = 0;
Uint32  TestMbox3 = 0;

#define	  K1		0xfeff
#define	  K2		0xfdff
#define	  K3		0xfbff
#define	  K4		0xf7ff
#define	  K5		0xefff
#define	  K6		0xdfff
#define	  K7		0xbfff
#define	  K8		0x7fff
#define	  K9		0xfeff
#define	  K10		0xfdff
#define	  K11		0xfbff
#define	  K12		0xf7ff
#define	  K13		0xefff
#define	  K14		0xdfff
#define	  K15		0xbfff
#define	  K16		0x7fff

interrupt void  T4pint_isr(void);//ÖĞ¶Ï×Ó³ÌĞòµÄÉùÃ÷
interrupt void  Ecan0inta_isr(void);

void IOinit()
{
 	EALLOW;  
 	//½«GPIOAÅäÖÃÎªÍâÉè¿Ú
 	GpioMuxRegs.GPAMUX.all = 0xffff;

    //½«GPIOE0~GPIOE2ÅäÖÃÎªÒ»°ãI/O¿ÚÊä³ö,×÷138ÒëÂë  
 	GpioMuxRegs.GPEMUX.all = GpioMuxRegs.GPEMUX.all&0xfff8; 
	GpioMuxRegs.GPEDIR.all = GpioMuxRegs.GPEDIR.all|0x0007;
    //½«GPIOB8~GPIOB15ÅäÖÃÎªÒ»°ãI/O¿Ú,D0~D7
	GpioMuxRegs.GPBMUX.all = GpioMuxRegs.GPBMUX.all&0x00ff;
	GpioMuxRegs.GPAMUX.bit.TDIRA_GPIOA11=0; //GPIOA11ÉèÖÃÎªÒ»°ãI/O¿Ú
	GpioMuxRegs.GPADIR.bit.GPIOA11=1;		//°ÑGPIOA11ÉèÖÃÎªÊä³ö 
	EDIS;
	GpioDataRegs.GPADAT.bit.GPIOA11=0; 	//GPIOA11=0;¸Ã¶Ë¿ÚÎª74HC595Ëø´æĞÅºÅ				
}

//SPI³õÊ¼»¯×Ó³ÌĞò
void spi_intial()
 {
 	SpiaRegs.SPICCR.all =0x0047;   // Ê¹SPI´¦ÓÚ¸´Î»·½Ê½, ÏÂ½µÑØ, °ËÎ»Êı¾İ  
	SpiaRegs.SPICTL.all =0x0006;   // Ö÷¿ØÄ£Ê½, Ò»°ãÊ±ÖÓÄ£Ê½,Ê¹ÄÜtalk, ¹Ø±ÕSPIÖĞ¶Ï.
	SpiaRegs.SPIBRR =0x007F;       //ÅäÖÃ²¨ÌØÂÊ
	SpiaRegs.SPICCR.all =SpiaRegs.SPICCR.all|0x0080;  // ÍË³ö¸´Î»×´Ì¬	 
	EALLOW;	
    GpioMuxRegs.GPFMUX.all=0x000F;	// ÉèÖÃÍ¨ÓÃÒı½ÅÎªSPIÒı½Å	 	
    EDIS;
  }

void  CAN_INIT()
{
	struct ECAN_REGS ECanaShadow;  
	EALLOW;
  	GpioMuxRegs.GPFMUX.bit.CANTXA_GPIOF6 = 1; //  ÉèÖÃGPIOF6ÎªCANTX 
  	GpioMuxRegs.GPFMUX.bit.CANRXA_GPIOF7 = 1; //  ÉèÖÃGPIOF7ÎªCANRX    	
	EDIS;
/*eCAN ¿ØÖÆ¼Ä´æÆ÷ĞèÒª32Î»·ÃÎÊ¡£Èç¹ûÏëÏòÒ»¸öµ¥¶ÀÎ»½øĞĞĞ´²Ù×÷£¬±àÒëÆ÷¿ÉÄÜ»áÊ¹Æä½øÈë16Î»·ÃÎÊ¡£Õâ¶ùÒıÓÃÁËÒ»ÖÖ½â¾ö·½·¨£¬¾ÍÊÇÓÃÓ°×Ó¼Ä´æÆ÷ÆÈÊ¹½øĞĞ32Î»·ÃÎÊ¡£ °ÑÕû¸ö¼Ä´æÆ÷¶ÁÈëÒ»¸öÓ°×Ó¼Ä´æÆ÷¡£ Õâ¸ö·ÃÎÊ½«ÊÇ32Î»µÄ¡£ÓÃ32Î»Ğ´²Ù×÷¸Ä±äĞèÒª¸ÄµÄÎ»£¬È»ºó°Ñ¸ÃÖµ¿½±´»ØeCAN¼Ä´æÆ÷*/
    EALLOW; 
   	ECanaShadow.CANTIOC.all = ECanaRegs.CANTIOC.all; //  °ÑCANTIOC¶ÁÈëÓ°×Ó¼Ä´æÆ÷
   	ECanaShadow.CANTIOC.bit.TXFUNC = 1;              //  Íâ²¿Òı½ÅI/OÊ¹ÄÜ±êÖ¾Î»¡£
//  TXFUNC£½1  CANTXÒı½Å±»ÓÃÓÚCAN·¢ËÍ¹¦ÄÜ¡£
//  TXFUNC£½0  CANTXÒı½Å±»×÷ÎªÍ¨ÓÃI/OÒı½Å±»Ê¹ÓÃ 
	ECanaRegs.CANTIOC.all = ECanaShadow.CANTIOC.all; //  °ÑÅäÖÃºÃµÄ¼Ä´æÆ÷Öµ»ØĞ´
    ECanaShadow.CANRIOC.all = ECanaRegs.CANRIOC.all;  //  °ÑCANRIOC¶ÁÓ°×Ó¼Ä´æÆ÷
	ECanaShadow.CANRIOC.bit.RXFUNC = 1;              //  Íâ²¿Òı½ÅI/OÊ¹ÄÜ±êÖ¾Î»¡£
//  RXFUNC£½1  CANRXÒı½Å±»ÓÃÓÚCAN½ÓÊÕ¹¦ÄÜ¡£
//  RXFUNC£½0  CANRXÒı½Å±»×÷ÎªÍ¨ÓÃI/OÒı½Å±»Ê¹ÓÃ¡£
    ECanaRegs.CANRIOC.all = ECanaShadow.CANRIOC.all;  //  °ÑÅäÖÃºÃµÄ¼Ä´æÆ÷Öµ»ØĞ´
    EDIS;
//  ÔÚÅäÖÃÓÊÏäIDÖµÖ®Ç°£¬CANME¶ÔÓ¦µÄÎ»±ØĞë¸´Î»£¬
//  Èç¹ûCANME¼Ä´æÆ÷ÖĞ¶ÔÓ¦µÄÎ»±»ÖÃÎ»£¬ÔòIDĞ´Èë²Ù×÷ÎŞĞ§¡£
	ECanaRegs.CANME.all = 0;                 //  ¸´Î»ËùÓĞµÄÓÊÏä
   	ECanaMboxes.MBOX0.MSGID.all = 0x15100000;  //  ÅäÖÃ·¢ËÍÓÊÏä0µÄID£ºÀ©Õ¹±êÊ¶·û29Î»  
    ECanaMboxes.MBOX16.MSGID.all = 0x15200000; //  È·¶¨½ÓÊÕÓÊÏä16ID 
    //  °ÑÓÊ0¡«15 ÅäÖÃÎª·¢ËÍÓÊÏä £¬ °ÑÓÊÏä16¡«31 ÅäÎª½ÓÊÕÓÊÏä
    ECanaRegs.CANMD.all = 0xFFFF0000; 
    ECanaRegs.CANME.all = 0xFFFFFFFF;         //  CANÄ£¿éÊ¹ÄÜ¶ÔÓ¦µÄÓÊÏä£¬
        
    ECanaMboxes.MBOX0.MSGCTRL.bit.DLC = 8;
    ECanaMboxes.MBOX1.MSGCTRL.bit.DLC = 8;       //  °Ñ·¢ËÍ£¬½ÓÊÕÊı¾İµÄ³¤¶È¶¨ÒåÎª8Î»
    ECanaMboxes.MBOX0.MSGCTRL.bit.RTR = 0;       //  ÎŞÔ¶³ÌÖ¡Çëó  
//  ÒòÎªRTRÎ»ÔÚ¸´Î»ºó×´Ì¬²»¶¨£¬Òò´ËÔÚ³ÌĞò½øĞĞ³õÊ¼»¯µÄÊ±ºò±ØĞë¶Ô¸ÃÎ»¸³Öµ¡£
    ECanaMboxes.MBOX1.MSGCTRL.bit.RTR = 0;
//  °Ñ´ı·¢ËÍµÄÊı¾İĞ´Èë·¢ËÍÓÊÏä 
 	ECanaMboxes.MBOX0.MDL.all = 0x55555555;
	ECanaMboxes.MBOX0.MDH.all = 0x55555501;	 
	EALLOW;
//  ÓÊÏäÖĞ¶ÏÆÁ±Î¼Ä´æÆ÷¡£ÉÏµçºóËùÓĞµÄÖĞ¶ÏÆÁ±ÎÎ»¶¼ÇåÁãÇÒÍ£Ö¹ÖĞ¶ÏÊ¹ÄÜ¡£
//  ÕâĞ©Î»ÔÊĞí¶ÀÁ¢ÆÁ±ÎÈÎºÎÓÊÏäÖĞ¶Ï¡£
	ECanaRegs.CANGIM.all = 0x0001;     //ÖĞ¶Ï0Ê¹ÄÜ
	ECanaRegs.CANMIM.all = 0xFFFFFFFF;  
//  CANMIM .BIT.X£½1  ÓÊÏäÖĞ¶Ï±»Ê¹ÄÜ£¨X£½1¡«31£©
//  CANMIM .BIT.X£½0  ÓÊÏäÖĞ¶Ï±»½ûÖ¹£¨X£½1¡«31£©
	ECanaShadow.CANMC.all = ECanaRegs.CANMC.all; //  °ÑCANMC¶ÁÈëÓ°×Ó¼Ä´æÆ÷
	ECanaShadow.CANMC.bit.CCR = 1;               //  ¸Ä±äÅäÖÃÇëÇóÎ»
	ECanaShadow.CANMC.bit.SCB = 1;  			//eCANÄ£Ê½,ËùÓĞÓÊÏäÊ¹ÄÜ
	ECanaRegs.CANMC.all = ECanaShadow.CANMC.all; //  °ÑÅäÖÃºÃµÄ¼Ä´æÆ÷Öµ»ØĞ´
  	EDIS;
/*CPUÒªÇó¶ÔÅäÖÃ¼Ä´æÆ÷CANBTCºÍSCCµÄ½ÓÊÕÆÁ±Î¼Ä´æÆ÷(CANGAM£¬LAM[0]ºÍLAM[3])½øĞĞĞ´²Ù×÷¡£¶Ô¸ÃÎ»ÖÃÎ»ºó£¬CPU±ØĞëµÈ´ı£¬Ö±µ½CANES¼Ä´æÆ÷µÄCCE±êÖ¾Î»ÔÚËÍÈëCANBTC¼Ä´æÆ÷Ö®Ç°Îª1 */
do 
    {
      ECanaShadow.CANES.all = ECanaRegs.CANES.all;
    } while(ECanaShadow.CANES.bit.CCE != 1 );  //  µ±CCE£½1Ê±¿ÉÒÔ¶ÔCANBTC½øĞĞ²Ù×÷¡£
    //  ÅäÖÃ²¨ÌØÂÊ
    EALLOW;
    ECanaShadow.CANBTC.all = ECanaRegs.CANBTC.all; //  °ÑCANBTC¶ÁÈëÓ°×Ó¼Ä´æÆ÷
    ECanaShadow.CANBTC.bit.BRPREG = 149;   //  (BRP+1)£½150£¬ ×îĞ¡Ê±¼äµ¥Î»TQ£½1us
    ECanaShadow.CANBTC.bit.TSEG2REG = 2;   //  Î»¶¨Ê±bit-time£½(TSEG1+1)+(TSEG1+1)+1
    ECanaShadow.CANBTC.bit.TSEG1REG = 3;   //  bit-time£½8us£¬ ËùÒÔ²¨ÌØÂÊÎª125Kpbs       
    ECanaRegs.CANBTC.all = ECanaShadow.CANBTC.all;  //  °ÑÅäÖÃºÃµÄ¼Ä´æÆ÷Öµ»ØĞ´
    ECanaShadow.CANMC.all = ECanaRegs.CANMC.all;   //  °ÑCANMC¶ÁÈëÓ°×Ó¼Ä´æÆ÷
    ECanaShadow.CANMC.bit.CCR = 0 ;       //  ÉèÖÃCCR£½0£¬ CPUÇëÇóÕı³£Ä£Ê½
    ECanaRegs.CANMC.all = ECanaShadow.CANMC.all;   //  °ÑÅäÖÃºÃµÄ¼Ä´æÆ÷Öµ»ØĞ´
    EDIS;
    do
    {
      ECanaShadow.CANES.all = ECanaRegs.CANES.all;
    } while(ECanaShadow.CANES.bit.CCE != 0 );  //  µÈ´ı CCE Î»±»ÇåÁã
//  ÅäÖÃeCANÎª×Ô²âÊÔÄ£Ê½£¬Ê¹ÄÜeCANµÄÔöÇ¿ÌØĞÔ
    EALLOW;
    ECanaShadow.CANMC.all = ECanaRegs.CANMC.all;
    ECanaShadow.CANMC.bit.STM = 0;        //  ÅäÖÃCAN ÎªÕı³£Ä£Ê½
  	// CANMC.bit.STM£½0£¬Õı³£Ä£Ê½£¬CANMC.bit.STM£½1£¬×Ô²âÊÔÄ£Ê½
    ECanaShadow.CANMC.bit.SCB = 1;        // Ñ¡ÔñHECC¹¤×÷Ä£Ê½
    ECanaRegs.CANMC.all = ECanaShadow.CANMC.all;
    EDIS;
}

void mailbox_read(int16 MBXnbr)
{
  	volatile struct MBOX *Mailbox;
	Mailbox = &ECanaMboxes.MBOX0 + MBXnbr;
	TestMbox1 = Mailbox->MDL.all;    	// ¶Á³öµ±Ç°ÓÊÏäÊı¾İµÍ4×Ö½Ú
	TestMbox2 = Mailbox->MDH.all;       //  ¶Á³öµ±Ç°ÓÊÏäÊı¾İ¸ß4×Ö½Ú
	TestMbox3 = Mailbox->MSGID.all;     //  ¶Á³öµ±Ç°ÓÊÏäID
} 

void LEDdisplay(int LED8,int LED7,int LED6,int LED5,int LED4,int LED3,int LED2,int LED1)
{
   
    GpioDataRegs.GPADAT.bit.GPIOA11=0; //¸øLACKĞÅºÅÒ»¸öµÍµçÆ½
	Write_LED (LED8);//ÏòLED×î¸ßÎ»Ğ´Êı¾İ,ÏÔÊ¾LED8
	Write_LED (LED7);
	Write_LED (LED6);
	Write_LED (LED5);
	Write_LED (LED4);
	Write_LED (LED3);
	Write_LED (LED2);
	Write_LED (LED1);//ÏòLED×îµÍÎ»Ğ´Êı¾İ,ÏÔÊ¾LED1

    GpioDataRegs.GPADAT.bit.GPIOA11=1; //¸øLACKĞÅºÅÒ»¸ö¸ßµçÆ½ÎªËø´æ74HC595     	
} 

void main(void)
{		
    asm (" NOP ");
   	InitSysCtrl();      //³õÊ¼»¯ÏµÍ³¿ØÖÆ¼Ä´æÆ÷, Ê±ÖÓÆµÂÊ150M
	DINT;	        //¹Ø±Õ×ÜÖĞ¶Ï£¬Çå³ıÖĞ¶Ï±êÖ¾
	IER = 0x0000;   //¹Ø±ÕÍâÎ§ÖĞ¶Ï
	IFR = 0x0000;	//ÇåÖĞ¶Ï±êÖ¾
	spi_intial();   //SPI³õÊ¼»¯×Ó³ÌĞò   
	IOinit();	    // I/O³õÊ¼»¯×Ó³Ì
   	CAN_INIT();	//³õÊ¼»¯SCl
	InitPieCtrl(); //³õÊ¼»¯PIE¿ØÖÆ¼Ä´æÆ÷ 
	InitPieVectTable(); //³õÊ¼»¯PIEÖĞ¶ÏÏòÁ¿±í
	LEDdisplay(0,0,0,19,19,0,0,0);

//T4£º°´¼ü £¬³õÊ¼»¯°´¼ü¼ì²âÖĞ¶Ï
	EvbRegs.T4PR=12000;	//T4¶¨Ê±Æ÷ÖÜÆÚ
	EvbRegs.T4CON.all=0x1744;	//x£¯128£¬Ôö¼ÆÊı10£®24 ms
	EvbRegs.T4CNT=0x0000;//T4¼ÆÊıÆ÷Çå

	EvbRegs.EVBIMRB.bit.T4PINT=1;	//Ê¹ÄÜT4PINTÖĞ¶Ï
	EvbRegs.EVBIFRB.bit.T4PINT=1;	//ÏÈÇå±êÖ¾
	InitXintf();	//³õÊ¼»¯XINTF
//####ÖĞ¶ÏÊ¹ÄÜ
	EALLOW;
	PieVectTable.T4PINT=&T4pint_isr;//PIEÖĞ¶ÏÊ¸Á¿±í	
	PieVectTable.ECAN0INTA=&Ecan0inta_isr;
	EDIS;
	PieCtrlRegs.PIEIER5.bit.INTx1=1;	//Ê¹ÄÜT4PINT	
	PieCtrlRegs.PIEIER9.bit.INTx5=1;	//Ê¹ÄÜECAN0lNT

	IER |=( M_INT5 |M_INT9 );//Ê¹ÄÜINT5£¬INT9

	EINT;	//¿ª·ÅÈ«¾ÖÖĞ¶Ï
	ERTM;	//Ê¹ÄÜÈ«¾ÖÊµÊ±ÖĞ¶Ï

//Ö÷Ñ­»·
   for(;;){;}
}

interrupt void   T4pint_isr(void)
	{	
 	    if (KeyIn1() == 1)     // µ÷ÓÃ²é¼üK1~K8×Ó³ÌĞò
 	    {
 	    keyNum=keyNum+1; 	 
	    KeyFunction1(KeyReg1);
	
		if(keyNum>3)
		{
		keyNum=keyNum-3;
		LED8=LEDReg;
		}
 	    if(keyNum==1)
		{
		LED8=LEDReg;
		}
		 if(keyNum==2)
		{
		LED7=LEDReg;
		}
		 if(keyNum==3)
		{
		LED6=LEDReg;
		} 	
		transmitChar=LED8*256+LED7*16+LED6;//×ª»»³ÉÊ®½øÖÆµÄÖµ
 		LEDdisplay(LED8,LED7,LED6,19,19,LED3,LED2,LED1); //ÏÔÊ¾·¢ËÍÎ»-ÃğÃğ-½ÓÊÕÎ»****

		EvbRegs.EVBIFRB.bit.T4PINT=1;	//ÖĞ¶Ï±êÖ¾Çå
		PieCtrlRegs.PIEACK.all=PIEACK_GROUP5; //ÔÊĞíÏÂ´ÎÖĞ¶Ï
		return;
		}

		if (KeyIn2() == 1)     // µ÷ÓÃ²é¼üK8~K16×Ó³ÌĞò
 	    {
 	    KeyFunction2(KeyReg2);	

	if(LEDReg==0x0B)		////ÅĞÊÇ·ñÎª¹¦ÄÜB¼ü CAN·¢ËÍ
		{	 	
		ECanaMboxes.MBOX0.MDL.all = 0x55555502;//·¢ËÍ±êÖ¾
		ECanaMboxes.MBOX0.MDH.all = transmitChar;
		ECanaRegs.CANTRS.all=0x0001; //·¢ËÍ0ÓÊÏä 
		while(ECanaRegs.CANTA.all!=0x0001) {};
		ECanaRegs.CANTA.all=0xFFFF;		//Ğ´1Çå.	
	 
		EvbRegs.EVBIFRB.bit.T4PINT=1;	//ÖĞ¶Ï±êÖ¾Çå
		PieCtrlRegs.PIEACK.all=PIEACK_GROUP5; //ÔÊĞíÏÂ´ÎÖĞ¶Ï
		return;
		}
 	   	keyNum=keyNum+1;		
		if(keyNum>3)
		{
		keyNum=keyNum-3;
		LED8=LEDReg;
		}
 	    if(keyNum==1)
		{
		LED8=LEDReg;
		}
		 if(keyNum==2)
		{
		LED7=LEDReg;
		}
		 if(keyNum==3)
		{
		LED6=LEDReg;
		}
 		
		transmitChar=LED8*256+LED7*16+LED6;//×ª»»³ÉÊ®½øÖÆµÄÖµ
 		LEDdisplay(LED8,LED7,LED6,19,19,LED3,LED2,LED1); //ÏÔÊ¾·¢ËÍÎ»-ÃğÃğ-½ÓÊÕÎ»
		EvbRegs.EVBIFRB.bit.T4PINT=1;	//ÖĞ¶Ï±êÖ¾Çå
		PieCtrlRegs.PIEACK.all=PIEACK_GROUP5; //ÔÊĞíÏÂ´ÎÖĞ¶Ï
		return; 		
	}
	EvbRegs.EVBIFRB.bit.T4PINT=1;	//ÖĞ¶Ï±êÖ¾Çå
	PieCtrlRegs.PIEACK.all=PIEACK_GROUP5; //ÔÊĞíÏÂ´ÎÖĞ¶Ï
	return;
}
interrupt void Ecan0inta_isr(void)	//½ÓÊÕĞÅÏ¢Ğü¹ÒÖĞ¶Ï
{
	if(ECanaRegs.CANRMP.all==0x00010000)
	 {
	ECanaRegs.CANRMP.all=0xFFFF0000;
 	mailbox_read(16);
	RecieveChar=TestMbox2;
	LED3=RecieveChar/256;
	LED2=(RecieveChar%256)/16;
	LED1=RecieveChar%16;
	LEDdisplay(LED8,LED7,LED6,19,19,LED3,LED2,LED1);	
	PieCtrlRegs.PIEACK.all=PIEACK_GROUP9; //ÔÊĞíÏÂ´ÎÖĞ¶Ï	
	return;
	}
	PieCtrlRegs.PIEACK.all=PIEACK_GROUP9; //ÔÊĞíÏÂ´ÎÖĞ¶Ï
	return;
}	

int KeyIn1(void)
{
 	 EALLOW;  
    //½«GPIOB8~GPIOB15ÅäÖÃÎªÊäÈë,D0~D7
	GpioMuxRegs.GPBDIR.all = GpioMuxRegs.GPBDIR.all&0x00ff;
     EDIS;    
    GpioDataRegs.GPEDAT.all = 0xfff8;     //Ñ¡Í¨KEYµÍ8Î»
    for (i=0; i<100; i++){}               //ÑÓÊ±
    //ÅĞK1~K8ÊÇ·ñ°´ÏÂ
    if ((GpioDataRegs.GPBDAT.all|0x00ff)!=0xffff)
    {
    	for (i=0; i<40000; i++){}        //ÑÓÊ±Ïû¶¶
        if ((GpioDataRegs.GPBDAT.all|0x00ff)!=0xffff)
        {
	   KeyReg1=GpioDataRegs.GPBDAT.all|0x00ff ;
    		while ((GpioDataRegs.GPBDAT.all|0x00ff)!=0xffff) //ÅĞÊÇ·ñËÉ¿ª
    		{
    			GpioDataRegs.GPDDAT.bit.GPIOD1 = !GpioDataRegs.GPDDAT.bit.GPIOD1;
    			for (i=0; i<1000; i++){}     
    		}
    		return (1);			      
    	}
    }
    return (0);
}

int KeyIn2(void)
{
 	 EALLOW;  
    //½«GPIOB8~GPIOB15ÅäÖÃÎªÊäÈë,D0~D7
	GpioMuxRegs.GPBDIR.all = GpioMuxRegs.GPBDIR.all&0x00ff;
     EDIS;    
    GpioDataRegs.GPEDAT.all = 0xfff9;     //Ñ¡Í¨KEY¸ß8Î»
    for (i=0; i<100; i++){}               //ÑÓÊ±
    //ÅĞs8~s16ÊÇ·ñ°´ÏÂ
    if ((GpioDataRegs.GPBDAT.all|0x00ff)!=0xffff)
    {
    	for (i=0; i<40000; i++){}        //ÑÓÊ±Ïû¶¶
        if ((GpioDataRegs.GPBDAT.all|0x00ff)!=0xffff)
        {
	   KeyReg2=GpioDataRegs.GPBDAT.all|0x00ff ;
    		while ((GpioDataRegs.GPBDAT.all|0x00ff)!=0xffff) //ÅĞÊÇ·ñËÍ¿ª
    		{
    			GpioDataRegs.GPDDAT.bit.GPIOD1 = !GpioDataRegs.GPDDAT.bit.GPIOD1;
    			for (i=0; i<1000; i++){}     
    		}
    		return (1);			      
    	}
    }
    return (0);
}

void	KeyFunction1(unsigned int KeyReg1)
		{
			switch(KeyReg1)
				{
					case  K1: {
								LEDReg= 0x00; 							
							  }
							  break;
					case  K2: {
								LEDReg= 0x01;							
							  }
							  break;
					case  K3: {
								LEDReg= 0x02;
							  }
							  break;
					case  K4: {
								LEDReg= 0x03;
							  }
							  break;
					case  K5: {
								LEDReg= 0x04;
							  }
							  break;
					case  K6: {
								LEDReg= 0x05;	
							  }
							  break;
					case  K7: {
								LEDReg= 0x06;
							  }
							  break;
					case  K8: {
								LEDReg= 0x07;
							  }	 		 
							  break; 			  
					default:  
							  break;
			}				  				  			  				   			  			  			   		
		}

 void	KeyFunction2(unsigned int KeyReg2)
		{
			switch(KeyReg2)
				{
					case  K9: {
								LEDReg= 0x08; 							
							  }
							  break;
					case  K10: {
								LEDReg= 0x09;							
							  }
							  break;
					case  K11: {
								LEDReg= 0x0A;
							  }
							  break;
					case  K12: {
								LEDReg= 0x0B;
							  }
							  break;
					case  K13: {
								LEDReg= 0x0C;
							  }
							  break;
					case  K14: {
								LEDReg= 0x0D;	
							  }
							  break;
					case  K15: {
								LEDReg= 0x0E;
							  }
							  break;
					case  K16: {
								LEDReg= 0x0F;
							  }	 		 
							  break; 			  
					default:  
							  break;
			}				  				  			  				   			  			  			   		
		}

//Í¨¹ıSPIÏòLED·¢ËÍÏÔÊ¾Êı¾İ
void Write_LED (int LEDReg)
{
Uint16 LEDcode[30]={0xc000,0xf900,0xA400,0xB000,0x9900,0x9200,0x8200,0xF800,
                    0x8000,0x9000,0x8800,0x8300,0xc600,0xa100,0x8600,0x8e00,
                    0x8c00,0xbf00,0xa700,0xff00,0x4000,0x7900,0x2400,0x3000,
                    0x1900,0x1200,0x0200,0x7800,0x0000,0x1000};//¹²Ñô×ÖĞÎÂë0~f, P£¬£­£¬L£¬"Ãğ",0.~9.	
	 		SpiaRegs.SPITXBUF =LEDcode[LEDReg]; //¸øÊıÂë¹ÜËÍÊı
    	 	 while(SpiaRegs.SPISTS.bit.INT_FLAG != 1){} 		
    		SpiaRegs.SPIRXBUF = SpiaRegs.SPIRXBUF; //¶Á³öÇå±êÖ¾
}
//=========================================================================================
// No more.
//=========================================================================================
